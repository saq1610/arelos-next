/* globals Nanobar, Postleaf */
$(function(){"use strict";var e,t,a="",l=!0,n=new Nanobar,s=1;$(".user-list").selectable({items:".user-list-item",multiple:!0,change:function(e){$(".edit, .open").prop("disabled",1!==e.length),$(".delete").prop("disabled",0===e.length)},doubleClick:function(e,t){location.href=$(t).attr("href")},getValue:function(){return $(this).attr("data-slug")}}),$(".user-list").on("scroll",function(){var t=this,a=$(t).scrollTop(),o=t.scrollHeight,i=$(t).height(),r=300,c=$(".user-search").val();!e&&l&&a+i+r>=o&&(n.go(50),e&&e.abort(),e=$.ajax({url:Postleaf.url("api/users"),type:"GET",data:{page:++s,query:c}}).done(function(a){e=null,l=s<a.pagination.total_pages,s<=a.pagination.total_pages&&$(t).append(a.html)}).always(function(){n.go(100)}))}),$(".user-search").on("change keyup paste",function(){var n=this,o=$(n).val(),i=$(n).closest(".inner-addon-group").find(".inner-addon i");clearTimeout(t),o!==a&&(t=setTimeout(function(){i.removeClass().addClass("loader"),e&&e.abort(),e=$.ajax({url:Postleaf.url("api/users"),type:"GET",data:{page:s=1,query:o}}).done(function(t){e=null,a=o,l=s<t.pagination.total_pages,$(".user-list").velocity("transition.fadeOut",100,function(){$(this).css("display","block").scrollTop(0).css("display","none").html(t.html).selectable("change").velocity("transition.fadeIn",100)})}).always(function(){i.removeClass().addClass("fa fa-search")})},300))}),$(".edit").on("click",function(){var e=$(".user-list").selectable("getElements",!0)[0].getAttribute("href");e&&(location.href=e)}),$(".open").on("click",function(){var e=$(".user-list").selectable("getElements",!0)[0].getAttribute("data-url");e&&window.open(e)}),$(".delete").on("click",function(){var e=$(".user-list").selectable("value"),t=$(".delete").attr("data-confirm"),a=0;0!==e.length&&$.alertable.confirm(t).then(function(){n.go(100/e.length/2),$.each(e,function(t,l){$.ajax({url:Postleaf.url("api/users/"+encodeURIComponent(l)),type:"DELETE"}).done(function(e){var t=$(".user-list").selectable("getElements",l);e.success&&($(t).remove(),$(".user-list").selectable("change")),e.message&&$.alertable.alert(e.message)}).always(function(){n.go(100*(++a/e.length))})})})})});