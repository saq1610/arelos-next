/* globals Nanobar, Postleaf */
$(function(){"use strict";var e,a=new Nanobar,t=$('input[name="user"]').val();$(".user-form").on("submit",function(n){var o=this,l=""===t?"POST":"PUT",r=Postleaf.url("POST"===l?"api/users":"api/users/"+encodeURIComponent(t));n.preventDefault(),e||(a.go(50),Postleaf.highlightErrors(o),e=$.ajax({url:r,type:l,data:$(o).serialize()}).done(function(e){e.success?($(o).off("submit").on("submit",function(e){e.preventDefault()}),Postleaf.announce($('meta[name="postleaf:language"]').attr("data-changes-saved"),{style:"success"}).then(function(){location.href=$(".user-form").attr("data-redirect")})):(Postleaf.highlightErrors(o,e.invalid),$.alertable.alert(e.message))}).always(function(){e=null,a.go(100)}))}),$(".open").on("click",function(){window.open($(this).attr("data-url"))}),$(".delete").on("click",function(){var e=$(this).attr("data-confirm");$.alertable.confirm(e).then(function(){a.go(50),$.ajax({url:Postleaf.url("api/users/"+encodeURIComponent(t)),type:"DELETE"}).done(function(e){e.message&&$.alertable.alert(e.message),e.success&&(location.href=$(".user-form").attr("data-redirect"))}).always(function(){a.go(100)})})}),$(".submit").on("click",function(){$(".user-form").submit()}),$("#username").on("change",function(){this.value=Postleaf.slug(this.value)}),$("#name").on("change",function(){var e=Postleaf.slug(this.value);""===$("#username").val()&&$("#username").val(e)}),$("#twitter").on("change",function(){this.value=this.value.replace(/@/g,"")}),$(".upload-avatar").on("change",'input[type="file"]',function(e){var t=this;e.target.files.length&&Postleaf.upload({accept:"image",image:{thumbnail:{width:512,height:512}},files:e.target.files[0],progress:function(e){a.go(e)}}).then(function(e){$(t).replaceWith($(t).clone()),e.uploaded.length&&($('input[name="avatar"]').val(e.uploaded[0].relative_path),$(".avatar .image").attr("src",e.uploaded[0].url).prop("hidden",!1),$(".avatar .none").prop("hidden",!0)),e.failed.length&&$.alertable.alert(e.failed[0].message)})}),$(".upload-cover").on("change",'input[type="file"]',function(e){var t=this;e.target.files.length&&Postleaf.upload({accept:"image",files:e.target.files[0],progress:function(e){a.go(e)}}).then(function(e){$(t).replaceWith($(t).clone()),e.uploaded.length&&($('input[name="cover"]').val(e.uploaded[0].relative_path),$(".cover").css("background-image",'url("'+e.uploaded[0].url+'")'),$(".remove-cover").prop("hidden",!1)),e.failed.length&&$.alertable.alert(e.failed[0].message)})}),$(".remove-cover").on("click",function(){$('input[name="cover"]').val(""),$(".cover").css("background-image","none"),$(".remove-cover").prop("hidden",!0)})});