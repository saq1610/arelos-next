/* globals Nanobar, Postleaf */
$(function(){"use strict";function e(){var e=$(".post-list").selectable("getElements",!0),t=$(e[0]).attr("data-url");$(".preview-panel").prop("hidden",!0),0===e.length?$(".preview-none").prop("hidden",!1):1===e.length?($(".preview-loader").prop("hidden",!1),$(".preview-frame").one("load",function(){$(".preview-loader").prop("hidden",!0),$(".preview-one").prop("hidden",!1),$("body *",$(".preview-frame").get(0).contentWindow.document).css("pointer-events","none").css("user-select","none")}),$(".preview-frame").get(0).contentWindow.document.location.replace(t)):$(".preview-multiple").prop("hidden",!1)}var t,n,o="",a=!0,l=new Nanobar,i=1;$(".post-list").selectable({items:".post-list-item",multiple:!0,change:function(t){$(".edit, .open").prop("disabled",1!==t.length),$(".delete").prop("disabled",0===t.length),$(".num-selected").text(t.length),e()},doubleClick:function(e,t){location.href=$(t).attr("href")},getValue:function(){return $(this).attr("data-slug")}}),$(".post-list").on("scroll",function(){var e=this,n=$(e).scrollTop(),o=e.scrollHeight,s=$(e).height(),r=300,c=$(".post-search").val();!t&&a&&n+s+r>=o&&(l.go(50),t&&t.abort(),t=$.ajax({url:Postleaf.url("api/posts"),type:"GET",data:{page:++i,query:c}}).done(function(n){t=null,a=i<n.pagination.total_pages,i<=n.pagination.total_pages&&$(e).append(n.html)}).always(function(){l.go(100)}))}),$(".post-search").on("change keyup paste",function(){var l=this,s=$(l).val(),r=$(l).closest(".inner-addon-group").find(".inner-addon i");clearTimeout(n),s!==o&&(n=setTimeout(function(){r.removeClass().addClass("loader"),t&&t.abort(),t=$.ajax({url:Postleaf.url("api/posts"),type:"GET",data:{page:i=1,query:s}}).done(function(n){t=null,o=s,a=i<n.pagination.total_pages,$(".post-list").velocity("transition.fadeOut",100,function(){$(this).css("display","block").scrollTop(0).css("display","none").html(n.html).selectable("change").velocity("transition.fadeIn",100),e()})}).always(function(){r.removeClass().addClass("fa fa-search")})},300))}),$(".edit").on("click",function(){var e=$(".post-list").selectable("getElements",!0)[0].getAttribute("href");e&&(location.href=e)}),$(".open").on("click",function(){var e=$(".post-list").selectable("getElements",!0)[0].getAttribute("data-url");e&&window.open(e)}),$(".delete").on("click",function(){var t=$(".post-list").selectable("value"),n=$(".delete").attr("data-confirm"),o=0;0!==t.length&&$.alertable.confirm(n).then(function(){l.go(100/t.length/2),$.each(t,function(n,a){$.ajax({url:Postleaf.url("api/posts/"+encodeURIComponent(a)),type:"DELETE"}).done(function(t){var n=$(".post-list").selectable("getElements",a);t.success&&($(n).remove(),$(".tag-list").selectable("change"),e())}).always(function(){l.go(100*(++o/t.length))})})})})});