/* globals Nanobar, Postleaf */
$(function(){"use strict";var t,e,a="",n=!0,l=new Nanobar,o=1;$(".tag-list").selectable({items:".tag-list-item",multiple:!0,change:function(t){$(".edit, .open").prop("disabled",1!==t.length),$(".delete").prop("disabled",0===t.length)},doubleClick:function(t,e){location.href=$(e).attr("href")},getValue:function(){return $(this).attr("data-slug")}}),$(".tag-list").on("scroll",function(){var e=this,a=$(e).scrollTop(),i=e.scrollHeight,s=$(e).height(),c=300,r=$(".tag-search").val();!t&&n&&a+s+c>=i&&(l.go(50),t&&t.abort(),t=$.ajax({url:Postleaf.url("api/tags"),type:"GET",data:{page:++o,query:r}}).done(function(a){t=null,n=o<a.pagination.total_pages,o<=a.pagination.total_pages&&$(e).append(a.html)}).always(function(){l.go(100)}))}),$(".tag-search").on("change keyup paste",function(){var l=this,i=$(l).val(),s=$(l).closest(".inner-addon-group").find(".inner-addon i");clearTimeout(e),i!==a&&(e=setTimeout(function(){s.removeClass().addClass("loader"),t&&t.abort(),t=$.ajax({url:Postleaf.url("api/tags"),type:"GET",data:{page:o=1,query:i}}).done(function(e){t=null,a=i,n=o<e.pagination.total_pages,$(".tag-list").velocity("transition.fadeOut",100,function(){$(this).css("display","block").scrollTop(0).css("display","none").html(e.html).selectable("change").velocity("transition.fadeIn",100)})}).always(function(){s.removeClass().addClass("fa fa-search")})},300))}),$(".edit").on("click",function(){var t=$(".tag-list").selectable("getElements",!0)[0].getAttribute("href");t&&(location.href=t)}),$(".open").on("click",function(){var t=$(".tag-list").selectable("getElements",!0)[0].getAttribute("data-url");t&&window.open(t)}),$(".delete").on("click",function(){var t=$(".tag-list").selectable("value"),e=$(".delete").attr("data-confirm"),a=0;0!==t.length&&$.alertable.confirm(e).then(function(){l.go(100/t.length/2),$.each(t,function(e,n){$.ajax({url:Postleaf.url("api/tags/"+encodeURIComponent(n)),type:"DELETE"}).done(function(t){var e=$(".tag-list").selectable("getElements",n);t.success&&($(e).remove(),$(".tag-list").selectable("change"))}).always(function(){l.go(100*(++a/t.length))})})})})});