/* globals Nanobar, Postleaf */
$(function(){"use strict";function e(){var e=$("#slug").val(),t=$.trim($("#meta-title").val())||$.trim($("#name").val()),a=$.trim($("#meta-description").val())||$.trim($(Postleaf.markdownToHtml($("#description").val())).text());$(".se-slug").text(e),$(".se-title").text(t),$(".se-description").text(a)}var t,a=new Nanobar,n=$('input[name="tag"]').val();$(".tag-form").on("submit",function(e){var o=this,l=""===n?"POST":"PUT",i=Postleaf.url("POST"===l?"api/tags":"api/tags/"+encodeURIComponent(n));e.preventDefault(),t||(a.go(50),Postleaf.highlightErrors(o),t=$.ajax({url:i,type:l,data:$(this).serialize()}).done(function(e){e.success?($(o).off("submit").on("submit",function(e){e.preventDefault()}),Postleaf.announce($('meta[name="postleaf:language"]').attr("data-changes-saved"),{style:"success"}).then(function(){location.href=Postleaf.adminUrl("tags")})):(Postleaf.highlightErrors(o,e.invalid),$.alertable.alert(e.message))}).always(function(){t=null,a.go(100)}))}),$(".open").on("click",function(){window.open($(this).attr("data-url"))}),$(".delete").on("click",function(){var e=$(this).attr("data-confirm");$.alertable.confirm(e).then(function(){a.go(50),$.ajax({url:Postleaf.url("api/tags/"+encodeURIComponent(n)),type:"DELETE"}).done(function(e){e.success?location.href=Postleaf.adminUrl("tags"):$.alertable.alert(e.message)}).always(function(){a.go(100)})})}),$(".submit").on("click",function(){$(".tag-form").submit()}),$("#slug").on("change",function(){this.value=Postleaf.slug(this.value)}),$("#name").on("change",function(){var e=Postleaf.slug(this.value);""===$("#slug").val()&&$("#slug").val(e)}),$("#name").on("change keyup paste",function(){$(".cover-name").text(this.value)}),$("#name, #description, #slug, #meta-title, #meta-description").on("change keyup paste",e),e(),$(".upload-cover").on("change",'input[type="file"]',function(e){var t=this;e.target.files.length&&Postleaf.upload({accept:"image",files:e.target.files[0],progress:function(e){a.go(e)}}).then(function(e){$(t).replaceWith($(t).clone()),e.uploaded.length&&($('input[name="cover"]').val(e.uploaded[0].relative_path),$(".cover").css("background-image",'url("'+e.uploaded[0].url+'")'),$(".remove-cover").prop("hidden",!1)),e.failed.length&&$.alertable.alert(e.failed[0].message)})}),$(".remove-cover").on("click",function(){$('input[name="cover"]').val(""),$(".cover").css("background-image","none"),$(".remove-cover").prop("hidden",!0)})});