/* globals Nanobar, Postleaf */
$(function(){"use strict";var a=new Nanobar;$(".settings-form").on("submit",function(e){var t=this;e.preventDefault(),a.go(50),Postleaf.highlightErrors(t),$.ajax({url:Postleaf.url("api/settings"),type:"POST",data:$(t).serialize()}).done(function(a){a.success?Postleaf.announce($('meta[name="postleaf:language"]').attr("data-changes-saved"),{style:"success"}):(Postleaf.highlightErrors(t,a.invalid),$.alertable.alert(a.message))}).always(function(){a.go(100)})}),$(".submit").on("click",function(){$(".settings-form").submit()}),$("#twitter").on("change",function(){this.value=this.value.replace(/@/g,"")}),$(".upload-cover").on("change",'input[type="file"]',function(e){var t=this;e.target.files.length&&Postleaf.upload({accept:"image",files:e.target.files[0],progress:function(e){a.go(e)}}).then(function(a){$(t).replaceWith($(t).clone()),a.uploaded.length&&($('input[name="cover"]').val(a.uploaded[0].relative_path),$(".cover").css("background-image",'url("'+a.uploaded[0].url+'")'),$(".remove-cover").prop("hidden",!1)),a.failed.length&&$.alertable.alert(a.failed[0].message)})}),$(".remove-cover").on("click",function(){$('input[name="cover"]').val(""),$(".cover").css("background-image","none"),$(".remove-cover").prop("hidden",!0)}),$(".upload-logo").on("change",'input[type="file"]',function(e){var t=this;e.target.files.length&&Postleaf.upload({accept:"image",files:e.target.files[0],progress:function(e){a.go(e)}}).then(function(a){$(t).replaceWith($(t).clone()),a.uploaded.length&&($('input[name="logo"]').val(a.uploaded[0].relative_path),$(".logo").css("background-image",'url("'+a.uploaded[0].url+'")'),$(".remove-logo").prop("hidden",!1)),a.failed.length&&$.alertable.alert(a.failed[0].message)})}),$(".remove-logo").on("click",function(){$('input[name="logo"]').val(""),$(".logo").css("background-image","none"),$(".remove-logo").prop("hidden",!0)}),$(".upload-favicon").on("change",'input[type="file"]',function(e){var t=this;e.target.files.length&&Postleaf.upload({accept:"image",image:{thumbnail:{width:512,height:512}},files:e.target.files[0],progress:function(e){a.go(e)}}).then(function(a){$(t).replaceWith($(t).clone()),a.uploaded.length&&($('input[name="favicon"]').val(a.uploaded[0].relative_path),$(".favicon").css("background-image",'url("'+a.uploaded[0].url+'")'),$(".remove-favicon").prop("hidden",!1)),a.failed.length&&$.alertable.alert(a.failed[0].message)})}),$(".remove-favicon").on("click",function(){$('input[name="favicon"]').val(""),$(".favicon").css("background-image","none"),$(".remove-favicon").prop("hidden",!0)}),$("[data-clear-cache]").on("click",function(){a.go(50),$.ajax({url:Postleaf.url("api/settings/cache"),type:"DELETE"}).done(function(a){Postleaf.announce(a.message,{style:"info"})}).always(function(){a.go(100)})}),$("[data-create-backup]").on("click",function(){$(".create-backup-loader").prop("hidden",!1),$("[data-create-backup]").prop("disabled",!0),$.ajax({url:Postleaf.url("api/backup"),type:"POST"}).done(function(a){a.success&&$(".available-backups").html(a.html),a.message&&$.alertable.alert(a.message)}).always(function(){$(".create-backup-loader").prop("hidden",!0),$("[data-create-backup]").prop("disabled",!1)})}),$(".available-backups").on("click","[data-delete-backup]",function(){var e=$(this).attr("data-delete-backup"),t=$(this).attr("data-confirm");$.alertable.confirm(t).then(function(){a.go(50),$.ajax({url:Postleaf.url("api/backup/"+encodeURIComponent(e)),type:"DELETE"}).done(function(a){$(".available-backups").html(a.html)}).always(function(){a.go(100)})})}),$(".available-backups").on("click","[data-download-backup]",function(){location.href=Postleaf.url("api/backup/"+encodeURIComponent($(this).attr("data-download-backup")))}),$(".available-backups").on("click","[data-restore-backup]",function(){var a=$(this),e=$(a).attr("data-restore-backup"),t=$(a).attr("data-confirm"),o=$(a).closest("td").find(".loader");$.alertable.prompt(t,{okButton:'<button class="btn btn-warning" type="submit">'+$('meta[name="postleaf:language"]').attr("data-ok")+"</button>",prompt:'<div class="form-group"><input type="password" class="form-control" id="login-prompt-password" name="password" autocomplete="off"></div>'}).then(function(t){$(a).prop("hidden",!0),$(o).prop("hidden",!1),$.ajax({url:Postleaf.url("api/backup/"+encodeURIComponent(e)+"/restore"),type:"POST",data:{password:t.password}}).done(function(a){a.message&&$.alertable.alert(a.message)}).always(function(){$(o).prop("hidden",!0),$(a).prop("hidden",!1)})})})});